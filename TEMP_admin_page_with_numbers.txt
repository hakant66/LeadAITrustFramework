"use client";

import { useCallback, useEffect, useState } from "react";

import Header from "@/app/(components)/Header";

type ProjectCreate = {
  slug: string;
  name: string;
  risk_level?: string;
  target_threshold: number; // 0..1
};

type ProjectSummary = {
  id: string;
  slug: string;
  name: string;
  risk_level?: string | null;
  target_threshold?: number | null;
};

type PillarPayload = {
  pillar: string;
  score_pct: number;
  maturity?: number;
};

type ScorePayload = {
  control_id: string;
  score: number;
};

const base =
  process.env.NEXT_PUBLIC_CORE_SVC_URL ??
  process.env.CORE_SVC_URL ??
  "http://localhost:8001";

const emptyProject: ProjectCreate = {
  slug: "",
  name: "",
  risk_level: "low",
  target_threshold: 0.75,
};

function ensureCloneSlug(sourceSlug: string, existing: Set<string>): string {
  const normalized =
    sourceSlug.trim().toLowerCase().replace(/\s+/g, "-") || "project";
  const root = `${normalized}-clone`;
  if (!existing.has(root)) return root;
  let idx = 2;
  let candidate = `${root}-${idx}`;
  while (existing.has(candidate)) {
    idx += 1;
    candidate = `${root}-${idx}`;
  }
  return candidate;
}

function extractPillarPayload(detail: any): PillarPayload[] {
  if (!Array.isArray(detail?.pillars)) return [];
  const results: PillarPayload[] = [];
  for (const raw of detail.pillars) {
    const pillar = String(
      raw?.pillar ?? raw?.pillar_key ?? raw?.name ?? ""
    ).trim();
    if (!pillar) continue;
    const scoreValue = Number(raw?.score_pct ?? raw?.score ?? NaN);
    if (!Number.isFinite(scoreValue)) continue;
    const maturityValue = Number(raw?.maturity);
    results.push({
      pillar,
      score_pct: Math.max(0, Math.min(100, Math.round(scoreValue))),
      maturity: Number.isFinite(maturityValue) ? maturityValue : undefined,
    });
  }
  return results;
}

function extractScorePayload(detail: any): ScorePayload[] {
  if (!Array.isArray(detail?.kpis)) return [];
  const items: ScorePayload[] = [];
  for (const k of detail.kpis) {
    const controlId = String(
      k?.key ?? k?.control_id ?? k?.kpi_id ?? ""
    ).trim();
    if (!controlId) continue;
    const rawValue = Number(k?.raw_value);
    const normalized = Number(k?.normalized_pct);
    const value = Number.isFinite(rawValue)
      ? rawValue
      : Number.isFinite(normalized)
      ? normalized
      : null;
    if (value === null) continue;
    items.push({ control_id: controlId, score: value });
  }
  return items;
}

export default function AdminCaptureProjectPage() {
  const [proj, setProj] = useState<ProjectCreate>({ ...emptyProject });
  const [createBusy, setCreateBusy] = useState(false);
  const [cloneBusy, setCloneBusy] = useState(false);
  const [deleteBusy, setDeleteBusy] = useState(false);
  const [updateBusy, setUpdateBusy] = useState(false);

  const [projects, setProjects] = useState<ProjectSummary[]>([]);
  const [projectsLoading, setProjectsLoading] = useState(false);
  const [cloneTarget, setCloneTarget] = useState("");
  const [deleteTarget, setDeleteTarget] = useState("");
  const [editTarget, setEditTarget] = useState("");
  const [editForm, setEditForm] = useState<ProjectCreate>({ ...emptyProject });

  const [msg, setMsg] = useState<string | null>(null);
  const [error, setError] = useState<string | null>(null);

  const loadProjects = useCallback(async () => {
    setProjectsLoading(true);
    try {
      const res = await fetch(`${base}/projects`, { cache: "no-store" });
      if (!res.ok) {
        throw new Error(`Failed to load projects (${res.status})`);
      }
      const data = await res.json();
      const list: ProjectSummary[] = Array.isArray(data)
        ? data.map((p: any) => ({
            id: String(p.id ?? ""),
            slug: String(p.slug ?? ""),
            name: String(p.name ?? p.slug ?? ""),
            risk_level: typeof p.risk_level === "string" ? p.risk_level : null,
            target_threshold:
              typeof p.target_threshold === "number"
                ? p.target_threshold
                : Number.isFinite(Number(p.target_threshold))
                ? Number(p.target_threshold)
                : null,
          }))
        : [];
      setProjects(list);
      if (list.length) {
        const fallbackSlug = list[0].slug;
        setCloneTarget((prev) =>
          prev && list.some((p) => p.slug === prev) ? prev : fallbackSlug
        );
        setDeleteTarget((prev) =>
          prev && list.some((p) => p.slug === prev) ? prev : fallbackSlug
        );
        setEditTarget((prev) =>
          prev && list.some((p) => p.slug === prev) ? prev : fallbackSlug
        );
      } else {
        setCloneTarget("");
        setDeleteTarget("");
        setEditTarget("");
        setEditForm({ ...emptyProject });
      }
    } catch (e: any) {
      setError(e?.message ?? String(e));
    } finally {
      setProjectsLoading(false);
    }
  }, []);

  useEffect(() => {
    void loadProjects();
  }, [loadProjects]);

  useEffect(() => {
    if (!editTarget) {
      setEditForm({ ...emptyProject });
      return;
    }
    const selected = projects.find((p) => p.slug === editTarget);
    if (selected) {
      setEditForm({
        slug: selected.slug,
        name: selected.name,
        risk_level: selected.risk_level ?? "low",
        target_threshold:
          typeof selected.target_threshold === "number"
            ? selected.target_threshold
            : 0.75,
      });
    }
  }, [editTarget, projects]);

  const onCreateProject = async () => {
    setCreateBusy(true);
    setMsg(null);
    setError(null);
    try {
      const res = await fetch(`${base}/admin/projects`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(proj),
      });
      if (!res.ok) {
        const j = await res.json().catch(() => ({}));
        throw new Error(j?.detail || `Create project failed (${res.status})`);
      }
      setMsg(`Project '${proj.slug}' created.`);
      setProj({ ...emptyProject });
      await loadProjects();
    } catch (e: any) {
      setError(e?.message ?? String(e));
    } finally {
      setCreateBusy(false);
    }
  };

  const handleCloneProject = async () => {
    if (!cloneTarget) return;
    setCloneBusy(true);
    setMsg(null);
    setError(null);
    try {
      const source = projects.find((p) => p.slug === cloneTarget);
      const detailRes = await fetch(
        `${base}/scorecard/${encodeURIComponent(cloneTarget)}`,
        { cache: "no-store" }
      );
      if (!detailRes.ok) {
        throw new Error(`Failed to load project data (${detailRes.status})`);
      }
      const payload = await detailRes.json();
      const sourceProject = payload?.project ?? {};
      const currentSlugs = new Set(projects.map((p) => p.slug));

      const canonicalSlug =
        String(sourceProject.slug ?? source?.slug ?? cloneTarget) || cloneTarget;
      const newSlug = ensureCloneSlug(canonicalSlug, currentSlugs);
      const newName = `${String(
        sourceProject.name ?? source?.name ?? cloneTarget
      )} clone`;
      const riskLevel =
        typeof sourceProject.risk_level === "string"
          ? sourceProject.risk_level
          : source?.risk_level ?? "low";
      const targetThreshold =
        typeof sourceProject.target_threshold === "number"
          ? sourceProject.target_threshold
          : typeof source?.target_threshold === "number"
          ? source?.target_threshold ?? 0.75
          : Number.isFinite(Number(source?.target_threshold))
          ? Number(source?.target_threshold)
          : 0.75;

      const createRes = await fetch(`${base}/admin/projects`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          slug: newSlug,
          name: newName,
          risk_level: riskLevel,
          target_threshold: targetThreshold,
        }),
      });
      if (!createRes.ok) {
        const j = await createRes.json().catch(() => ({}));
        throw new Error(
          j?.detail || `Clone failed during creation (${createRes.status})`
        );
      }

      const pillarPayload = extractPillarPayload(payload);

      if (pillarPayload.length) {
        const pillarsRes = await fetch(
          `${base}/scorecard/${encodeURIComponent(newSlug)}/pillars`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ pillars: pillarPayload }),
          }
        );
        if (!pillarsRes.ok) {
          const text = await pillarsRes.text().catch(() => "");
          throw new Error(
            `Failed to copy pillars (${pillarsRes.status}): ${text}`
          );
        }
      }

      const scorePayload = extractScorePayload(payload);

      if (scorePayload.length) {
        const scoreRes = await fetch(
          `${base}/scorecard/${encodeURIComponent(newSlug)}`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ scores: scorePayload }),
          }
        );
        if (!scoreRes.ok) {
          const text = await scoreRes.text().catch(() => "");
          throw new Error(
            `Failed to copy KPI scores (${scoreRes.status}): ${text}`
          );
        }
      }

      setMsg(
        `Project '${newName}' cloned from '${source?.name ?? cloneTarget}'.`
      );
      await loadProjects();
      setCloneTarget(newSlug);
      setDeleteTarget(newSlug);
      setEditTarget(newSlug);
    } catch (e: any) {
      setError(e?.message ?? String(e));
    } finally {
      setCloneBusy(false);
    }
  };

  const handleDeleteProject = async () => {
    if (!deleteTarget) return;
    const project = projects.find((p) => p.slug === deleteTarget);
    if (typeof window !== "undefined") {
      const confirmed = window.confirm(
        "Are you sure? All data will be permanently deleted."
      );
      if (!confirmed) return;
    }
    setDeleteBusy(true);
    setMsg(null);
    setError(null);
    try {
      const res = await fetch(
        `${base}/projects/${encodeURIComponent(deleteTarget)}`,
        { method: "DELETE" }
      );
      if (!res.ok && res.status !== 204) {
        const text = await res.text().catch(() => "");
        throw new Error(
          text || `Delete failed (${res.status || "unknown status"})`
        );
      }
      setMsg(`Project '${project?.name ?? deleteTarget}' deleted.`);
      await loadProjects();
    } catch (e: any) {
      setError(e?.message ?? String(e));
    } finally {
      setDeleteBusy(false);
    }
  };

  const handleUpdateProject = async () => {
    if (!editTarget) return;
    setUpdateBusy(true);
    setMsg(null);
    setError(null);
    try {
      const original = projects.find((p) => p.slug === editTarget);
      if (!original) {
        throw new Error("Selected project not found.");
      }

      const desiredSlug = editForm.slug.trim();
      if (!desiredSlug) {
        throw new Error("Slug cannot be empty.");
      }
      const targetThreshold = Number(editForm.target_threshold);
      if (!Number.isFinite(targetThreshold) || targetThreshold < 0 || targetThreshold > 1) {
        throw new Error("Target threshold must be between 0 and 1.");
      }

      const payload = {
        slug: desiredSlug,
        name: editForm.name.trim() || desiredSlug,
        risk_level: editForm.risk_level?.trim() || "low",
        target_threshold: targetThreshold,
      };

      if (desiredSlug === original.slug) {
        const res = await fetch(`${base}/admin/projects`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          const text = await res.text().catch(() => "");
          throw new Error(text || `Update failed (${res.status})`);
        }
      } else {
        const detailRes = await fetch(
          `${base}/scorecard/${encodeURIComponent(original.slug)}`,
          { cache: "no-store" }
        );
        if (!detailRes.ok) {
          throw new Error(
            `Failed to load project data for rename (${detailRes.status})`
          );
        }
        const detail = await detailRes.json();

        const createRes = await fetch(`${base}/admin/projects`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!createRes.ok) {
          const text = await createRes.text().catch(() => "");
          throw new Error(
            text || `Failed to create renamed project (${createRes.status})`
          );
        }

        const pillarPayload = extractPillarPayload(detail);
        if (pillarPayload.length) {
          const pillarsRes = await fetch(
            `${base}/scorecard/${encodeURIComponent(desiredSlug)}/pillars`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ pillars: pillarPayload }),
            }
          );
          if (!pillarsRes.ok) {
            const text = await pillarsRes.text().catch(() => "");
            throw new Error(
              `Failed to migrate pillars (${pillarsRes.status}): ${text}`
            );
          }
        }

        const scorePayload = extractScorePayload(detail);
        if (scorePayload.length) {
          const scoreRes = await fetch(
            `${base}/scorecard/${encodeURIComponent(desiredSlug)}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ scores: scorePayload }),
            }
          );
          if (!scoreRes.ok) {
            const text = await scoreRes.text().catch(() => "");
            throw new Error(
              `Failed to migrate KPI scores (${scoreRes.status}): ${text}`
            );
          }
        }

        const deleteRes = await fetch(
          `${base}/projects/${encodeURIComponent(original.slug)}`,
          { method: "DELETE" }
        );
        if (!deleteRes.ok && deleteRes.status !== 204) {
          const text = await deleteRes.text().catch(() => "");
          throw new Error(
            text || `Failed to delete old project (${deleteRes.status})`
          );
        }
      }

      setMsg(`Project '${payload.name}' updated.`);
      await loadProjects();
      setEditTarget(payload.slug);
      setCloneTarget(payload.slug);
      setDeleteTarget(payload.slug);
    } catch (e: any) {
      setError(e?.message ?? String(e));
    } finally {
      setUpdateBusy(false);
    }
  };

  return (
    <main className="min-h-screen bg-gray-50">
      <div className="px-6 py-6 max-w-4xl mx-auto space-y-6">
        <Header title="AI Projects Admin" subtitle="LeadAI - Admin Tools">
          <div className="flex flex-col sm:flex-row gap-3">
            <a
              href="/scorecard"
              className="inline-flex items-center justify-center px-3 py-2 rounded-xl border border-indigo-100 bg-white text-indigo-700 hover:bg-indigo-50 transition"
            >
              Back to AI Projects
            </a>
          </div>
        </Header>

        {error && (
          <div className="rounded-xl border border-red-200 bg-red-50 text-red-700 px-4 py-3">
            {error}
          </div>
        )}
        {msg && (
          <div className="rounded-xl border border-emerald-200 bg-emerald-50 text-emerald-700 px-4 py-3">
            {msg}
          </div>
        )}

        <section className="border rounded-2xl bg-white shadow-sm p-4 space-y-3">
          <div className="flex items-center justify-between gap-3 flex-wrap">
            <div>
              <div className="text-lg font-semibold">Change AI Project</div>
              <p className="text-sm text-gray-600">
                Update project properties or rename an existing scorecard.
              </p>
            </div>
            <select
              className="rounded-lg border px-3 py-2"
              value={editTarget}
              onChange={(e) => setEditTarget(e.target.value)}
              disabled={projectsLoading || projects.length === 0}
            >
              {projects.length === 0 ? (
                <option value="">No projects yet</option>
              ) : (
                projects.map((p) => (
                  <option key={p.slug} value={p.slug}>
                    {p.name} ({p.slug})
                  </option>
                ))
              )}
            </select>
          </div>

          <div className="grid grid-cols-1 gap-3">
            <label className="text-sm">
              <div className="text-gray-600 mb-1">Slug</div>
              <input
                className="w-full rounded-lg border px-3 py-2"
                value={editForm.slug}
                onChange={(e) =>
                  setEditForm((prev) => ({ ...prev, slug: e.target.value }))
                }
                placeholder="contract-analysis"
                disabled={!editTarget || projectsLoading}
              />
            </label>

            <label className="text-sm">
              <div className="text-gray-600 mb-1">Name</div>
              <input
                className="w-full rounded-lg border px-3 py-2"
                value={editForm.name}
                onChange={(e) =>
                  setEditForm((prev) => ({ ...prev, name: e.target.value }))
                }
                placeholder="Contract Analysis"
                disabled={!editTarget || projectsLoading}
              />
            </label>

            <label className="text-sm">
              <div className="text-gray-600 mb-1">Risk level</div>
              <select
                className="w-full rounded-lg border px-3 py-2"
                value={editForm.risk_level}
                onChange={(e) =>
                  setEditForm((prev) => ({ ...prev, risk_level: e.target.value }))
                }
                disabled={!editTarget || projectsLoading}
              >
                <option value="low">low</option>
                <option value="medium">medium</option>
                <option value="high">high</option>
              </select>
            </label>

            <label className="text-sm">
              <div className="text-gray-600 mb-1">Target threshold (0..1)</div>
              <input
                type="number"
                step="0.01"
                min={0}
                max={1}
                className="w-full rounded-lg border px-3 py-2"
                value={editForm.target_threshold}
                onChange={(e) =>
                  setEditForm((prev) => ({
                    ...prev,
                    target_threshold: Number(e.target.value),
                  }))
                }
                disabled={!editTarget || projectsLoading}
              />
            </label>
          </div>

          <div className="flex gap-3 flex-wrap items-center">
            <button
              type="button"
              onClick={handleUpdateProject}
              disabled={
                !editTarget ||
                updateBusy ||
                projectsLoading ||
                !editForm.slug.trim() ||
                !editForm.name.trim()
              }
              className="inline-flex items-center justify-center rounded-xl bg-indigo-600 text-white px-4 py-2 disabled:opacity-50"
            >
              {updateBusy ? "Saving..." : "Save Changes"}
            </button>
            {editForm.slug && (
              <a
                className="inline-flex items-center rounded-xl border px-4 py-2 hover:bg-gray-50 transition"
                href={`/scorecard/${encodeURIComponent(
                  editForm.slug
                )}/dashboard/admin`}
              >
                Go to project admin
              </a>
            )}
          </div>

          <p className="text-xs text-gray-500">
            Changing the slug will move all scorecard data to the new slug and delete the original project.
          </p>
        </section>

        <section className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div className="border rounded-2xl bg-white shadow-sm p-4 md:col-span-2">
            <div className="text-lg font-semibold mb-3">Capture AI Project</div>

            <div className="grid grid-cols-1 gap-3">
              <label className="text-sm">
                <div className="text-gray-600 mb-1">Slug</div>
                <input
                  className="w-full rounded-lg border px-3 py-2"
                  placeholder="contract-analysis"
                  value={proj.slug}
                  onChange={(e) => setProj({ ...proj, slug: e.target.value })}
                />
              </label>

              <label className="text-sm">
                <div className="text-gray-600 mb-1">Name</div>
                <input
                  className="w-full rounded-lg border px-3 py-2"
                  placeholder="Contract Analysis"
                  value={proj.name}
                  onChange={(e) => setProj({ ...proj, name: e.target.value })}
                />
              </label>

              <label className="text-sm">
                <div className="text-gray-600 mb-1">Risk level</div>
                <select
                  className="w-full rounded-lg border px-3 py-2"
                  value={proj.risk_level}
                  onChange={(e) =>
                    setProj({ ...proj, risk_level: e.target.value })
                  }
                >
                  <option value="low">low</option>
                  <option value="medium">medium</option>
                  <option value="high">high</option>
                </select>
              </label>

              <label className="text-sm">
                <div className="text-gray-600 mb-1">Target threshold (0..1)</div>
                <input
                  type="number"
                  step="0.01"
                  min={0}
                  max={1}
                  className="w-full rounded-lg border px-3 py-2"
                  value={proj.target_threshold}
                  onChange={(e) =>
                    setProj({
                      ...proj,
                      target_threshold: Number(e.target.value),
                    })
                  }
                />
              </label>

              <div className="flex gap-2 items-center flex-wrap">
                <button
                  disabled={
                    createBusy ||
                    !proj.slug.trim() ||
                    !proj.name.trim() ||
                    Number.isNaN(proj.target_threshold)
                  }
                  onClick={onCreateProject}
                  className="mt-2 inline-flex items-center justify-center rounded-xl bg-indigo-600 text-white px-4 py-2 disabled:opacity-50"
                >
                  {createBusy ? "Creating..." : "Create Project"}
                </button>

                {proj.slug && (
                  <a
                    className="mt-2 inline-flex items-center rounded-xl border px-4 py-2 hover:bg-gray-50 transition"
                    href={`/scorecard/${encodeURIComponent(
                      proj.slug
                    )}/dashboard/admin`}
                  >
                    Go to this project's admin
                  </a>
                )}
              </div>
            </div>
          </div>

          <div className="border rounded-2xl bg-white shadow-sm p-4 space-y-3">
            <div className="text-lg font-semibold">Clone AI Project</div>
            <p className="text-sm text-gray-600">
              Duplicate an existing project. The new project keeps KPI scores
              and pillar overrides, with the name suffixed by <code>clone</code>.
            </p>
            <label className="text-sm">
              <div className="text-gray-600 mb-1">Project to clone</div>
              <select
                className="w-full rounded-lg border px-3 py-2"
                value={cloneTarget}
                onChange={(e) => setCloneTarget(e.target.value)}
                disabled={projectsLoading || cloneBusy || projects.length === 0}
              >
                {projects.length === 0 ? (
                  <option value="">No projects yet</option>
                ) : (
                  projects.map((p) => (
                    <option key={p.slug} value={p.slug}>
                      {p.name} ({p.slug})
                    </option>
                  ))
                )}
              </select>
            </label>
            <button
              type="button"
              onClick={handleCloneProject}
              disabled={!cloneTarget || cloneBusy || projectsLoading}
              className="inline-flex items-center justify-center rounded-xl bg-indigo-600 text-white px-4 py-2 disabled:opacity-50"
            >
              {cloneBusy ? "Cloning..." : "Clone Project"}
            </button>
          </div>

          <div className="border rounded-2xl bg-white shadow-sm p-4 space-y-3">
            <div className="text-lg font-semibold text-red-600">
              Delete AI Project
            </div>
            <p className="text-sm text-gray-600">
              Remove a project and all of its scorecard data from the backend.
            </p>
            <label className="text-sm">
              <div className="text-gray-600 mb-1">Project to delete</div>
              <select
                className="w-full rounded-lg border px-3 py-2"
                value={deleteTarget}
                onChange={(e) => setDeleteTarget(e.target.value)}
                disabled={projectsLoading || deleteBusy || projects.length === 0}
              >
                {projects.length === 0 ? (
                  <option value="">No projects yet</option>
                ) : (
                  projects.map((p) => (
                    <option key={p.slug} value={p.slug}>
                      {p.name} ({p.slug})
                    </option>
                  ))
                )}
              </select>
            </label>
            <button
              type="button"
              onClick={handleDeleteProject}
              disabled={!deleteTarget || deleteBusy || projectsLoading}
              className="inline-flex items-center justify-center rounded-xl bg-red-600 text-white px-4 py-2 disabled:opacity-50"
            >
              {deleteBusy ? "Deleting..." : "Delete Project"}
            </button>
          </div>
        </section>

        <div className="text-sm text-gray-600">
          Need to manage global controls? Go to{" "}
          <a className="underline" href="/scorecard/controls">
            Controls manager
          </a>
          .
        </div>
      </div>
    </main>
  );
}
